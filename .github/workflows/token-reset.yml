name: Daily Token Reset
on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  reset-tokens:
    runs-on: ubuntu-latest
    steps:
      - name: Check Environment Variables
        run: |
          echo "üîç Checking environment variables..."
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "‚ùå SUPABASE_URL secret is missing"
            exit 1
          fi
          
          if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "‚ùå SUPABASE_SERVICE_ROLE_KEY secret is missing"
            exit 1
          fi
          
          echo "‚úÖ Environment variables are configured"

      - name: Call Token Reset Function
        run: |
          echo "üöÄ Starting token reset process..."
          
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/process-anniversary-resets" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            --max-time 60)
          
          # Extract HTTP code and response body
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          response_body=$(echo "$response" | sed '/HTTP_CODE:/d')
          
          echo "üìã HTTP Status Code: $http_code"
          echo "üìÑ Response Body: $response_body"
          
          # Check if function exists and is accessible
          if [ "$http_code" = "404" ]; then
            echo "‚ùå Function not found - the Edge Function doesn't exist or isn't deployed"
            echo "üí° Deploy with: supabase functions deploy process-anniversary-resets"
            exit 1
          elif [ "$http_code" = "401" ] || [ "$http_code" = "403" ]; then
            echo "‚ùå Authentication failed - check your service role key"
            echo "üí° Get service role key from Supabase Dashboard ‚Üí Settings ‚Üí API"
            exit 1
          elif [ "$http_code" = "500" ]; then
            echo "‚ùå Server error - function exists but has an internal error"
            echo "üí° Check Edge Function logs in Supabase Dashboard"
            echo "Error details: $response_body"
            exit 1
          elif [ "$http_code" = "200" ]; then
            echo "‚úÖ Function called successfully"
            
            # Check if the response indicates success
            if echo "$response_body" | grep -q '"success":true'; then
              echo "üéâ Token reset completed successfully"
              
              # Extract and display results
              processed_count=$(echo "$response_body" | grep -o '"processed_count":[0-9]*' | cut -d: -f2)
              if [ -n "$processed_count" ] && [ "$processed_count" -gt 0 ]; then
                echo "üìä Processed $processed_count user token resets"
              else
                echo "‚ÑπÔ∏è No users were due for token reset today"
              fi
            else
              echo "‚ö†Ô∏è Function ran but returned an error"
              echo "Response: $response_body"
              exit 1
            fi
          else
            echo "‚ùì Unexpected HTTP code: $http_code"
            echo "Response: $response_body"
            exit 1
          fi

      - name: Verify Function Deployment
        if: failure()
        run: |
          echo "üîç Troubleshooting steps:"
          echo ""
          echo "1. Check if Edge Function is deployed:"
          echo "   - Go to Supabase Dashboard ‚Üí Edge Functions"
          echo "   - Look for 'process-anniversary-resets' function"
          echo ""
          echo "2. If function is missing, deploy it:"
          echo "   supabase functions deploy process-anniversary-resets"
          echo ""
          echo "3. Test manually:"
          echo "   curl -X POST \"${{ secrets.SUPABASE_URL }}/functions/v1/process-anniversary-resets\" \\"
          echo "     -H \"Authorization: Bearer YOUR_SERVICE_ROLE_KEY\" \\"
          echo "     -H \"Content-Type: application/json\""
          echo ""
          echo "4. Check function logs in Supabase Dashboard for errors"

      - name: Log Results
        if: always()
        run: |
          echo "üèÅ Token reset job completed at $(date)"
          echo "üìä Job status: ${{ job.status }}"
